<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ˆê°ˆë‹¨ ìŠ¤í„°ë”” í†µí•© ëŒ€ì‹œë³´ë“œ (Bright Ver.)</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; margin: 0; }
        .banner { width: 100%; max-height: 300px; object-fit: cover; border-bottom: 3px solid #e74c3c; }
        .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #eee; }
        
        /* íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-link { padding: 15px 25px; cursor: pointer; font-weight: bold; color: #999; transition: 0.3s; }
        .tab-link:hover { color: #e74c3c; }
        .tab-link.active { color: #e74c3c; border-bottom: 4px solid #e74c3c; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ê³µí†µ ìŠ¤íƒ€ì¼ ë° ë‹¬ë ¥ */
        h2 { color: #e74c3c; text-align: center; margin-top: 0; }
        .sub-title { color: #666; text-align: center; margin-bottom: 20px; }
        input.name-input { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #e74c3c; border-radius: 8px; background: #fff; color: #333; text-align: center; font-size: 1.1em; box-sizing: border-box; }
        .month-controls { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; font-size: 1.3em; font-weight: bold; color: #333; }
        .btn-move { background: none; border: none; color: #e74c3c; font-size: 1.5em; cursor: pointer; padding: 0 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day { height: 120px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px; background: #fff; overflow-y: auto; cursor: pointer; transition: 0.2s; }
        .day:hover { background-color: #ffeceb; border-color: #e74c3c; }
        .day-number { font-weight: bold; margin-bottom: 5px; display: block; color: #333; }
        .submitter-tag { display: block; font-size: 11px; background: #2c3e50; color: #fff; padding: 3px 6px; margin-bottom: 3px; border-radius: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .my-submit { background: #e74c3c; }

        /* ëª¨ë‹¬ (íŒì—…) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 500px; max-width: 90%; max-height: 80vh; display: flex; flex-direction: column; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-header { color: #e74c3c; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2em; font-weight: bold; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .task-list { list-style: none; padding: 0; margin: 0 0 20px 0; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .task-item { background: #f9f9f9; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #bdc3c7; }
        .task-author { font-weight: bold; color: #333; margin-bottom: 4px; font-size: 0.9em; }
        .task-desc { white-space: pre-wrap; font-size: 0.95em; color: #555; }
        textarea.task-input, textarea.feed-input, textarea.comment-input { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: none; box-sizing: border-box; font-family: inherit; background: #fff; color: #333; margin-bottom: 10px; }
        textarea:focus { border-color: #e74c3c; outline: none; }
        .btn-submit { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.3s; }
        .btn-submit:hover { background: #c0392b; }
        .close-btn { cursor: pointer; font-size: 1.5em; color: #999; }

        /* ë­í‚¹ íƒ­ */
        .ranking-list { list-style: none; padding: 0; }
        .ranking-item { background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .rank { font-weight: bold; font-size: 1.2em; color: #e74c3c; margin-right: 15px; }
        .rank-name { flex-grow: 1; font-weight: bold; color: #333; }
        .rank-count { color: #666; font-size: 0.9em; }

        /* ë¼ˆì´ìŠ¤ë¶ íƒ­ */
        .feed-form { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        .feed-list { list-style: none; padding: 0; }
        .feed-item { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .feed-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: #e74c3c; font-weight: bold; }
        .feed-date { color: #999; font-size: 0.8em; }
        .feed-content { white-space: pre-wrap; color: #333; margin-bottom: 20px; line-height: 1.5; }
        .comment-section { border-top: 1px solid #eee; padding-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .comment-list { list-style: none; padding: 0; margin-bottom: 15px; }
        .comment-item { background: #fff; padding: 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.9em; border: 1px solid #eee; }
        .comment-author { color: #333; font-weight: bold; margin-right: 5px; }
        .comment-content { color: #555; }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; color: #e74c3c; font-size: 1.5em; font-weight:bold; z-index: 2000; }
    </style>
</head>
<body>

<img src="banner.jpg" alt="ë¼ˆê°ˆë‹¨ ë°°ë„ˆ" class="banner">

<div id="loadingMsg" class="loading-overlay">ğŸ”¥ ë¼ˆê°ˆë‹¨ ë°ì´í„° ë¡œë”© ì¤‘...</div>

<div class="container">
    <input type="text" id="userName" class="name-input" placeholder="ë‹¹ì‹ ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (í•„ìˆ˜!)">

    <div class="tabs">
        <div class="tab-link active" onclick="openTab('calendarTab')">ğŸ“… ì„±ê³¼ ë‹¬ë ¥</div>
        <div class="tab-link" onclick="openTab('rankingTab')">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</div>
        <div class="tab-link" onclick="openTab('snsTab')">ğŸ’€ ë¼ˆì´ìŠ¤ë¶</div>
    </div>

    <div id="calendarTab" class="tab-content active">
        <h2>â˜ ï¸ ì›”ê°„ ì„±ê³¼ í˜„í™©</h2>
        <div class="sub-title">ì˜¤ëŠ˜ë„ ë¼ˆë¥¼ ê°ˆì•„ ë„£ì—ˆëŠ”ê°€?</div>
        <div class="month-controls">
            <button class="btn-move" onclick="changeMonth(-1)">â—€</button>
            <span id="currentMonth" style="margin: 0 20px;"></span>
            <button class="btn-move" onclick="changeMonth(1)">â–¶</button>
            <button onclick="loadData()" style="font-size:0.8em; margin-left:10px; cursor:pointer; background:none; border:none; color:#e74c3c;">ğŸ”„</button>
        </div>
        <div class="calendar-grid" id="calendar"></div>
    </div>

    <div id="rankingTab" class="tab-content">
        <h2>ğŸ† ìµœë‹¤ ë¼ˆê°ˆì´ ë­í‚¹</h2>
        <div class="sub-title">ê°€ì¥ ë§ì´ ë¼ˆë¥¼ ê°„ ìëŠ” ëˆ„êµ¬ì¸ê°€?</div>
        <ul id="rankingList" class="ranking-list">
            <li style="text-align:center; color:#999; padding: 20px;">ì•„ì§ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
    </div>

    <div id="snsTab" class="tab-content">
        <h2>ğŸ’€ ë¼ˆì´ìŠ¤ë¶ í”¼ë“œ</h2>
        <div class="sub-title">ì¼ìƒ, ì¡ë‹´, ì¼ì • ê³µìœ ì˜ ì¥</div>
        <div class="feed-form">
            <textarea id="inputFeed" class="feed-input" placeholder="ë¬´ìŠ¨ ìƒê°ì„ í•˜ê³  ê³„ì‹ ê°€ìš”? (ì¼ìƒ, ê³µìœ , ì¡ë‹´ ë“±)"></textarea>
            <button class="btn-submit" onclick="saveFeed()">í”¼ë“œ ê²Œì‹œí•˜ê¸°</button>
        </div>
        <ul id="feedList" class="feed-list">
            <li style="text-align:center; color:#999; padding: 20px;">ì•„ì§ ì‘ì„±ëœ í”¼ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</li>
        </ul>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalDateTitle"></span>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <h4 style="color:#e74c3c; margin-top:0;">ğŸ“‹ ë©¤ë²„ë“¤ì˜ ì¼ê³¼</h4>
            <ul id="taskList" class="task-list"></ul>
            <h4 style="color:#e74c3c;">âœï¸ ë‚˜ì˜ ì¼ê³¼ ê¸°ë¡</h4>
            <textarea id="inputTask" class="task-input" placeholder="ì˜¤ëŠ˜ ë¼ˆë¥¼ ê°ˆì•„ë„£ì€ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”..."></textarea>
            <button class="btn-submit" onclick="saveTask()">ë“±ë¡ / ìˆ˜ì •í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // âš ï¸ [ì¤‘ìš”] Google Apps Script ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  [ìƒˆ ë°°í¬] í›„ ì–»ì€ ìƒˆ URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcDojsbQuoxfczj-RzkduCzxrALHXtB2vy4ZdL65MMgerCuM-sud3HIyiN0RYPYsiGLw/exec"; 
    // ============================================================

    let currentDate = new Date();
    let dbData = { tasks: [], feeds: [], comments: [] }; // ë°ì´í„° êµ¬ì¡° ë³€ê²½
    let selectedDateKey = null;

    window.onload = function() {
        const savedName = localStorage.getItem('study_username');
        if(savedName) document.getElementById('userName').value = savedName;
        loadData();
    };

    document.getElementById('userName').addEventListener('change', function() {
        localStorage.setItem('study_username', this.value);
        renderCalendar(); renderRanking(); renderFeed(); // ì´ë¦„ ë³€ê²½ ì‹œ ëª¨ë“  ë·° ê°±ì‹ 
    });

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function openTab(tabName) {
        const tabContents = document.getElementsByClassName('tab-content');
        for (let i = 0; i < tabContents.length; i++) { tabContents[i].classList.remove('active'); }
        const tabLinks = document.getElementsByClassName('tab-link');
        for (let i = 0; i < tabLinks.length; i++) { tabLinks[i].classList.remove('active'); }
        document.getElementById(tabName).classList.add('active');
        event.currentTarget.classList.add('active');
        if (tabName === 'rankingTab') renderRanking();
        if (tabName === 'snsTab') renderFeed();
    }

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (í†µí•©)
    function loadData() {
        if(SCRIPT_URL.includes("YOUR_GOOGLE")) {
            document.getElementById('loadingMsg').style.display = 'none'; alert("SCRIPT_URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); return;
        }
        document.getElementById('loadingMsg').style.display = 'flex';
        // action=getAllData íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ ì„œë²„ì— ìš”ì²­
        fetch(SCRIPT_URL + "?action=getAllData")
            .then(response => response.json())
            .then(data => {
                dbData = data; // ì„œë²„ê°€ ì¤€ {tasks:[], feeds:[], comments:[]} í˜•íƒœë¥¼ ë°›ìŒ
                document.getElementById('loadingMsg').style.display = 'none';
                renderCalendar();
                renderRanking(); // ë°ì´í„° ë¡œë“œ í›„ ë­í‚¹ë„ ê°±ì‹ 
                renderFeed();    // ë°ì´í„° ë¡œë“œ í›„ í”¼ë“œë„ ê°±ì‹ 
            })
            .catch(error => {
                document.getElementById('loadingMsg').style.display = 'none'; alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨.");
            });
    }

    // ë Œë”ë§ í•¨ìˆ˜ë“¤... (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê±°ë‚˜ ì•½ê°„ ìˆ˜ì •)
    function renderCalendar() { 
        const calendarEl = document.getElementById('calendar'); calendarEl.innerHTML = '';
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        document.getElementById('currentMonth').innerText = `${year}ë…„ ${month + 1}ì›”`;
        const lastDay = new Date(year, month + 1, 0).getDate();
        const myName = document.getElementById('userName').value.trim();
        for (let i = 1; i <= lastDay; i++) {
            const dateKey = `${year}-${month+1}-${i}`;
            const dayEl = document.createElement('div'); dayEl.className = 'day';
            dayEl.innerHTML = `<span class="day-number">${i}</span>`;
            // dbData.tasks ë°°ì—´ì—ì„œ í•„í„°ë§
            const todaysData = dbData.tasks.filter(item => item.date === dateKey);
            todaysData.forEach(item => {
                const tag = document.createElement('span'); tag.className = 'submitter-tag'; tag.innerText = item.name;
                if (myName && item.name === myName) tag.classList.add('my-submit');
                dayEl.appendChild(tag);
            });
            dayEl.onclick = () => openModal(dateKey); calendarEl.appendChild(dayEl);
        }
    }
    
    function renderRanking() {
        const rankingListEl = document.getElementById('rankingList'); rankingListEl.innerHTML = '';
        if (dbData.tasks.length === 0) { rankingListEl.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">ì•„ì§ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>'; return; }
        
        const counts = {};
        dbData.tasks.forEach(task => { counts[task.name] = (counts[task.name] || 0) + 1; });
        const sortedRanking = Object.entries(counts).sort((a, b) => b[1] - a[1]);

        sortedRanking.forEach((item, index) => {
            const li = document.createElement('li'); li.className = 'ranking-item';
            li.innerHTML = `<span class="rank">${index + 1}ìœ„</span><span class="rank-name">${item[0]}</span><span class="rank-count">${item[1]}íšŒ ì œì¶œ</span>`;
            rankingListEl.appendChild(li);
        });
    }

    function renderFeed() {
        const feedListEl = document.getElementById('feedList'); feedListEl.innerHTML = '';
        if (dbData.feeds.length === 0) { feedListEl.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">ì•„ì§ ì‘ì„±ëœ í”¼ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</li>'; return; }

        dbData.feeds.slice().reverse().forEach(feed => { // ìµœì‹ ìˆœ ì •ë ¬
            const li = document.createElement('li'); li.className = 'feed-item';
            const feedComments = dbData.comments.filter(c => c.feedId === feed.id);
            let commentsHtml = '';
            feedComments.forEach(c => { commentsHtml += `<li class="comment-item"><span class="comment-author">${c.name}</span><span class="comment-content">${c.content}</span></li>`; });

            li.innerHTML = `
                <div class="feed-header"><span>${feed.name}</span><span class="feed-date">${new Date(feed.timestamp).toLocaleString()}</span></div>
                <div class="feed-content">${feed.content}</div>
                <div class="comment-section">
                    <ul class="comment-list" id="commentList-${feed.id}">${commentsHtml}</ul>
                    <div style="display:flex;"><textarea id="commentInput-${feed.id}" class="comment-input" style="height:40px; margin-bottom:0; margin-right:10px;" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..."></textarea><button class="btn-submit" style="width:80px; padding:0;" onclick="saveComment('${feed.id}')">ì „ì†¡</button></div>
                </div>
            `;
            feedListEl.appendChild(li);
        });
    }

    // ì €ì¥ í•¨ìˆ˜ë“¤... (action íŒŒë¼ë¯¸í„° ì¶”ê°€ê°€ í•µì‹¬)
    function saveTask() {
        const name = document.getElementById('userName').value.trim(); const task = document.getElementById('inputTask').value.trim();
        if (!name || !task) { alert("ì´ë¦„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        // action: 'saveTask'ë¥¼ ì¶”ê°€í•˜ì—¬ ì„œë²„ê°€ ì•Œ ìˆ˜ ìˆê²Œ í•¨
        const newData = { action: 'saveTask', date: selectedDateKey, name: name, task: task };
        dbData.tasks.push(newData); renderCalendar(); closeModal(); document.getElementById('inputTask').value = '';
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(newData) });
    }

    function saveFeed() {
        const name = document.getElementById('userName').value.trim(); const content = document.getElementById('inputFeed').value.trim();
        if (!name || !content) { alert("ì´ë¦„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        const feedId = 'feed_' + new Date().getTime();
        // action: 'saveFeed' ì¶”ê°€
        const newData = { action: 'saveFeed', id: feedId, name: name, content: content, timestamp: new Date().toISOString() };
        dbData.feeds.push(newData); renderFeed(); document.getElementById('inputFeed').value = '';
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(newData) });
    }

    function saveComment(feedId) {
        const name = document.getElementById('userName').value.trim(); const content = document.getElementById(`commentInput-${feedId}`).value.trim();
        if (!name || !content) { alert("ì´ë¦„ê³¼ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        // action: 'saveComment' ì¶”ê°€
        const newData = { action: 'saveComment', feedId: feedId, name: name, content: content, timestamp: new Date().toISOString() };
        dbData.comments.push(newData); renderFeed();
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(newData) });
    }

    // ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ëª¨ë‹¬, ë‹¬ë ¥ ì´ë™ ë“± - ê¸°ì¡´ê³¼ ë™ì¼)
    function openModal(date) {
        selectedDateKey = date; document.getElementById('modalDateTitle').innerText = `${date} í˜„í™©`;
        const taskListEl = document.getElementById('taskList'); taskListEl.innerHTML = '';
        const todaysTasks = dbData.tasks.filter(d => d.date === date);
        if (todaysTasks.length === 0) { taskListEl.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">ì•„ì§ ì•„ë¬´ë„ ë¼ˆë¥¼ ê°ˆì§€ ì•Šì•˜ìŠµë‹ˆë‹¤...ğŸ¦´</li>'; } 
        else { todaysTasks.forEach(item => { taskListEl.innerHTML += `<li class="task-item"><div class="task-author">${item.name}</div><div class="task-desc">${item.task}</div></li>`; }); }
        document.getElementById('inputTask').value = ''; document.getElementById('taskModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('taskModal').style.display = 'none'; }
    function changeMonth(step) { currentDate.setMonth(currentDate.getMonth() + step); renderCalendar(); }
    window.onclick = function(e) { if(e.target == document.getElementById('taskModal')) closeModal(); }
</script>
</body>
</html>